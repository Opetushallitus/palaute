sudo: required

language: java

jdk:
  - openjdk11

services:
  - docker

cache:
  directories:
    - $HOME/.m2

env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "wHUP3nsiXRNqhujHz5wHfY84HduO5XHrf2wD7dHR/S0uXiPYuJFaaGqc8A9YMcoACCrM/g1y7k+5SgXes8QdECab5VLwiNMeIDJ6DYg8FFn9qoaFoTiHGfkCACLrbAGmGah1RnzHpkvdusgulJfFO2pGy3LnCbxQUgHxY90ea7sKS99GONzP1WfAxlkpC/CdjBbOKV56XTrrOh/dClN+BNNALTrSiBpwXgm770Bum+oJhOhD6MvXWxFwlFB+bk4TgTUbsApAh62+M/Hgc+09SslDuAY+eqottZQ1EmVBxZNEY8XpIDuzPSInJccxTi/yI+8h9QsACAdTXQKpWC/0biTeau//CHa2zguGBeKFrKZPHYLC6rlOQmSSh2g2a+wXvPqgNQhGjjUEZh++2I9VoWnbWJIzftdlP9QM1pnVNUXvpG3OIqaqCKhQiatdg9561f+p7Ngwh3+ZnF2eHFFIqaRYelSiPJqDaY/Bv9mV8C+nC4dRIrNvarfZ1Fs9tZDwIldc3ET5pP7Nm94UNZUxsypjoaD6izWsj/iHqp/r9a60a8xeTBsKpClXUH/BoK5YYfhqww9P57z0sueaqYeEFnv+lj0Lif9LokDfpYVVckEN/N/wWpWCFXXFx+xZiws7XKfjMdrhAezjJuFEq7d6P+kvQ5tSv2KU5444Nhttwfw="
    # AWS_SECRET_ACCESS_KEY
    - secure: "bJUfmzynSfARbJXJCeey4I5ERBVLiV+CW/Co/cpktOoUd9T1ikMEEIfXi7N9KRlj7o93MCKtuTrsTivsPWdtgqne9ITJIax11FUnzHMlRk37n3rQa496dhxaoJcs4ln72u+H+8a6s3NxLUq9n0IG9TUCKOSwbH2jBJpK/h3MnwwU9l4axVLGI91l+uhztMy2Wd8WdrmPQqxe/sEm3cjR9SHxQsUNSTWSAhrP6vfyFAcIU5zqyIT8CQWdgkQRhJSlZw05+cqXKjvrGy11/IFXSeYRiv+svlYAA0jz64UNPxEJLbh8tt2/HUcwXVoYHfQcxgIE+2KNgrOaonP/CNcdJN3ZeLUwSWkNDLG/yxP5/B/MyP2axPOOQ+d6o6cIld/5Wa2uHFt6dQ0Rj0b3ux0KmS49+WP7khWDkUVUHg8EtwCmTh6jaUxQDkKGa8tWhcaIXZZo2v2ANfmrKb6ots1V3u1fVQm6MVxIvsmuO8EVORfy9cC/FlZh3gDif4MXzsvLRTO1auzf7OjSdwGta5euW/GCcPpLEgrfwpYqFL/vjnZ6ZLDJYhDS+rwvXVHbiUcXDBhloD/dSxwGSCVSbZIwHv2qBo0KXN1ExgXMplolPd4yc+ALBwEO9PFB0pB97yPKpHl3eCIl++sHWc5HirTKauHyDu7Hv12lCPNdmbbX+6I="

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - sudo sh -c "printf '\n%s penaali.hard.ware.fi\n' $(dig +short artifactory.opintopolku.fi|head -n1) >> /etc/hosts"
  - export ARTIFACT_NAME="palaute"

script:
  - mvn clean package -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

  - mv target/palaute-0.0.1-SNAPSHOT-jar-with-dependencies.jar $DOCKER_BUILD_DIR/artifact/${ARTIFACT_NAME}.jar
  - cp -vr src/main/resources/oph-configuration $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-fatjar:jdk11"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
